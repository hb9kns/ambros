#!/bin/sh
# sniptime:
# cut input text to given duration (empty line as separator),
# or calculate total duration (if duration is missing or 0)
#
# args: speed/WpM, [duration/sec]
# stdin: standardized text
# stdout: duration/sec | cut text

# Morse character table, generated by chargen.sh
chartab=`dirname $0`/chartab.txt
# speedbase: VVVVV=64, CODEX=60, PARIS=50
speedbase=${SPEEDBASE:-50}

# calculate duration/ditunits of characters, which must be given as
# separate arguments
wordduration() {
local wd cd
wd=0
# loop through characters
while test ! -z $1
do
# search character in chartab, remove first and third column
 cd=`grep -F "_$1" $chartab`
 cd=${cd#* }
 cd=${cd% *}
# echo : $1 : cd=$cd >&2
# empty if not found, then set duration 0
 cd=${cd:-0}
# and add to word total
 wd=`expr $wd + $cd`
 shift
done
#echo : $1 : wd=$wd >&2
echo $wd
}

if test -z $1
then echo "$0 : missing speed/WpM" >&2
 exit 2
fi

# speed in dit units per minute
ditspeed=`expr $speedbase '*' $1`
#echo : ditspeed $ditspeed
# set duration to 0 if empty, i.e calculate duration
duration=${2:-0}
#echo : $duration sec
# convert from seconds into ditunits
duration=`expr $duration '*' $ditspeed / 60`
#echo : $duration ditunits

# flag for dumping of remaining text
dump=0
# separate words into lines, and remove empty lines
sed -e 's/[	_ ][	_ ]*/\
/g;/^[	_ ]*$/d' | {
 total=0
 while read word
 do
 if test $dump -eq 0
 then
# separate characters with spaces, making each into one argument
  sword="`echo $word|sed -e 's/\(.\)/ \1/g'`"
# calculate duration of word including inter-word pause (_)
  total="$total + `wordduration $sword _`"
# echo :: total = $total >&2
  total=`expr $total`
# 0<duration<total, then add empty separator line and dump remaining text
  if test $duration -gt 0 -a $duration -lt $total
  then
   echo
   dump=1
  fi
 fi
# output word if not in measurement mode
 if test $duration -gt 0
 then echo "$word"
 fi
 done
# duration<=0, then report duration
 if test $duration -le 0
# convert from ditunits back into seconds and return duration
 then expr $total '*' 60 / $ditspeed
 fi
}
